version: "3.8"

services:
  selenium:
    image: selenium/standalone-chrome
    shm_size: 2300m  # ~2.3g, только integer
    environment:
      - START_XVFB=false  # для --headless-режиме можно поставить в false
      - SE_NODE_OVERRIDE_MAX_SESSIONS=true  # позволяет запустить больше сессий на одной ноде селениума
      - SE_NODE_MAX_SESSIONS=16  # поставил по количеству потоков процессора
      - JAVA_OPTS=-Dselenium.LOGGER.level=WARNING  # должно отключать логи селениума, но не работает?
      - JAVA_OPTS=-Dwebdriver.chrome.whitelistedIps= # должно убирать спам в логи с сообщением [99]
    ports:
      - "4444" # 4444:4444, если нужно выставить порт наружу
    restart: always

  redis:
    image: redis
    restart: always
    ports:
      - "6379" # 6379:6379, если нужно выставить порт наружу

  app:
    image: malkiz/pw-autoreg
    restart: always
    env_file:
      - .env
    deploy:
      replicas: 10
    volumes:
      - pw-accounts:/app/accounts
      - registrations-debug-screenshots:/app/screenshots
    depends_on:
      - selenium
      - redis

volumes:
  pw-accounts:
    name: pw-accounts
  registrations-debug-screenshots:
    name: registrations-debug-screenshots
